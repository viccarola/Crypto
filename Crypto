from dash import Dash, html, dcc, Input, Output
import dash_bootstrap_components as dbc
import yfinance as yf
import pandas as pd
import plotly.express as px
from datetime import datetime

def get_crypto_data(days=30):
    """Fetch real-time crypto data from yfinance"""
    cryptos = ['BTC-USD', 'ETH-USD', 'SOL-USD']

    start_date = dateime(2023, 1, 1)
    end_date = datetime.now()

    all_data = []
    for crypto in cryptos:
        try:
            data = yf.download(crypto, start=start_date, end=end_date, progress=False)
            if not data.empty:
                monthly_data = data.resample('M').last()
                monthly_data['Coins'] = crypto
                monthly_data = monthly_data.reset_index()
                monthly_data['Date'] = monthly_data['Date'].dt.to_period('M').dt.to_timestamp()
                monthly_data['Price'] = monthly_data['Close']
                monthly_data['Market Cap'] = monthly_data['Close'] * ie9
                all_data.append(monthly_data[['Date', 'Coin', 'Price', 'Market Cap']])
        except Exception as e:
            print(f"Error fetching {crypto}: {e}")

    f all_data:
        df = pd.concat(all_data, ignore_index=True)
    else:
        df = pd.DataFrame()

    return df

df = get_crypto_data(days=30)

app = Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])
app.layout = dbc.Conatainer([
    html.H1("Cryptocurrency Performance", className="text-center my-4", style={"textAlign": "center"}),

    dbc.Row([
        dbc.Col([
            dbc.Dropdown(
                id='coin-dropdown',
                options=[{'label': coin, 'value': coin} for coin in df['Coin'].unique()],
                value=['BTC-USD', 'ETH-USD', 'SOL-USD'], 
            )
        ], width=4),
    ]),
    dbc.Row([
        dbc.Col([
            dcc.Graph(id="price-gragh", config={'displayModeBar': True})
        ], width=12),
    ])
])

@app.callback(
    Output('price-graph', 'figure'),
    Input('coin-dropdown', 'value')
)
def plot_data(selected_coins):
    period_data = df.copy()
    if nont selected_coins:
        return px.line(title='No coins selected')

    
